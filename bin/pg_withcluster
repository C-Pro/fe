#!/usr/bin/env python
"""
Entry point for pg_withcluster.
"""
import tempfile
import subprocess as sp
from optparse import OptionParser
from postgresql.cluster import Cluster

op = OptionParser(
	"%prog [-p] [--version] {[setting=value], ...} [pg_config] command",
	version = '1.0'
)
op.allow_interspersed_args = False
op.add_option(
	'-p',
	dest = 'look_in_path',
	help = 'Look for "pg_config" in the PATH environment',
	action = 'store_true',
	default = False
)
co, ca = op.parse_args(args[1:])
if not ca:
	sys.stderr.write("no command given to run in cluster context")
	sys.exit(1)

i = 0
for x in ca:
	if '=' not in x:
		break
	i += 1
settings = ca[0:i]
command = ca[i:]
d = tempfile.mkdtemp()
try:
	c = Cluster.create(d)
	c.settings.update([
		x.split('=', 1) for x in settings
	])
	c.control.start()
	try:
		p = sp.Popen(
			command,
			env = {
			},
		)
		return p.wait()
	finally:
		c.control.stop()
finally:
	c.drop()
